<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro-Qu√©bec Monitor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="config.js"></script>
    <style>
        *{font-family:'Inter',system-ui,sans-serif}
        .glass{background:rgba(255,255,255,0.05);backdrop-filter:blur(10px)}
        .animate-pulse-slow{animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .shake{animation:shake 0.3s ease-out}
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:3px}
        .leaflet-container{background:#1e293b}
        .marker-pin{width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
        .marker-pin.ok{background:#22c55e}
        .marker-pin.panne{background:#ef4444;animation:pulse 1.5s infinite}
        .marker-hq{width:14px;height:14px;border-radius:50%;background:#f97316;border:2px solid #fff}
        .leaflet-popup-content-wrapper{background:#1e293b;color:white;border-radius:12px}
        .leaflet-popup-tip{background:#1e293b}
        .leaflet-pane{z-index:400!important}
        #modal,#login-screen{z-index:99999!important}
        .autocomplete-list{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-top:4px;max-height:200px;overflow-y:auto;z-index:1000}
        .autocomplete-item{padding:10px 16px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px}
        .autocomplete-item:hover,.autocomplete-item.active{background:rgba(59,130,246,0.2)}
        .autocomplete-item small{color:#94a3b8;display:block;margin-top:2px;font-size:11px}
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-indigo-950 text-white">
    <!-- Login -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl border border-white/10 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Hydro-Qu√©bec Monitor</h1>
                <p class="text-slate-400 mt-2" id="login-org">Acc√®s r√©serv√©</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Mot de passe</label>
                    <input type="password" id="password-input" required placeholder="Entrez le mot de passe" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                </div>
                <div id="error-message" class="hidden text-red-400 text-sm text-center py-2 bg-red-500/10 rounded-lg">Mot de passe incorrect</div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 rounded-xl">üîê Acc√©der</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
        <header class="border-b border-white/10 glass sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-xl"><svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
                    <div class="hidden sm:block"><h1 class="text-lg font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Hydro-Qu√©bec Monitor</h1><p class="text-xs text-slate-500" id="org-name"></p></div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="error-banner" class="hidden text-amber-400 text-xs bg-amber-500/10 px-3 py-1.5 rounded-lg"></span>
                    <span class="text-xs text-slate-500 hidden md:block" id="last-update">--:--</span>
                    <button onclick="toggleZones()" id="zones-btn" class="p-2 sm:px-3 sm:py-2 bg-orange-500/20 border border-orange-500/30 rounded-xl text-sm text-orange-400">üî• <span class="hidden sm:inline">Zones HQ</span></button>
                    <button onclick="refreshData()" id="refresh-btn" class="p-2 sm:px-4 sm:py-2 bg-white/5 border border-white/10 rounded-xl text-sm flex items-center gap-2"><div class="w-2 h-2 bg-amber-400 rounded-full animate-pulse" id="status-dot"></div><span class="hidden sm:inline" id="refresh-text">Actualiser</span></button>
                    <div class="relative group" style="z-index:10000">
                        <button class="p-2 hover:bg-white/10 rounded-xl"><div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-sm font-bold">C</div></button>
                        <div class="absolute right-0 top-full mt-2 w-56 glass rounded-xl border border-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible" style="z-index:10001">
                            <div class="p-3 border-b border-white/10"><p class="font-medium" id="menu-org"></p><p class="text-xs text-slate-500">Connect√©</p></div>
                            <div class="p-2">
                                <button onclick="exportData()" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-white/10 rounded-lg">üì§ Exporter</button>
                                <label class="block px-3 py-2 text-sm text-slate-300 hover:bg-white/10 rounded-lg cursor-pointer">üì• Importer<input type="file" accept=".json" onchange="importData(this.files[0])" class="hidden"></label>
                                <button onclick="resetConfig()" class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-white/10 rounded-lg">üîÑ Charger config.js</button>
                                <hr class="my-2 border-white/10">
                                <button onclick="logout()" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg">üö™ D√©connexion</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-black/20 border-b border-white/5">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-4 text-sm">
                <span class="text-slate-400">üìç <span id="stat-total">0</span> adresses</span>
                <span class="text-green-400">‚úÖ <span id="stat-ok">0</span> OK</span>
                <span class="text-red-400">‚ö° <span id="stat-panne">0</span> panne</span>
                <span class="text-orange-400">üî• <span id="stat-hq">0</span> zones HQ</span>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4" style="min-height:calc(100vh - 180px)">
                <div class="lg:col-span-1 flex flex-col glass rounded-2xl border border-white/10 overflow-hidden order-2 lg:order-1">
                    <div class="p-4 border-b border-white/10 space-y-3">
                        <div class="relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="Rechercher..." class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex gap-2" id="filter-btns">
                            <button onclick="setFilter('tous')" data-f="tous" class="flex-1 py-2 rounded-lg text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">üìç Tous</button>
                            <button onclick="setFilter('panne')" data-f="panne" class="flex-1 py-2 rounded-lg text-xs font-medium bg-white/5 text-slate-400">‚ö° Panne</button>
                            <button onclick="setFilter('normal')" data-f="normal" class="flex-1 py-2 rounded-lg text-xs font-medium bg-white/5 text-slate-400">‚úÖ OK</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="list" style="max-height:50vh"></div>
                    <div class="p-4 border-t border-white/10">
                        <button onclick="openModal()" class="w-full bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-500/30 text-blue-400 font-medium py-3 rounded-xl">‚ûï Ajouter une adresse</button>
                    </div>
                </div>
                <div class="lg:col-span-2 rounded-2xl border border-white/10 overflow-hidden relative order-1 lg:order-2" style="min-height:400px">
                    <div id="map" class="w-full h-full" style="min-height:400px;height:100%"></div>
                    <div class="absolute bottom-4 left-4 glass rounded-xl p-3 text-xs border border-white/10 z-[600]">
                        <div class="font-semibold mb-2">L√©gende</div>
                        <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-green-500 border-2 border-white"></div><span class="text-green-400">OK</span></div>
                        <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-red-500 border-2 border-white"></div><span class="text-red-400">En panne</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-orange-500/60 border-2 border-orange-400"></div><span class="text-orange-400">Zone HQ</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-lg font-bold">‚ûï Ajouter une adresse</h2>
                <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 text-xl">‚úï</button>
            </div>
            <form onsubmit="handleAdd(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Nom</label>
                    <input type="text" id="input-nom" required placeholder="Ex: Bureau principal" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Adresse <span class="text-slate-500">(suggestions auto)</span></label>
                    <input type="text" id="input-addr" required placeholder="Tapez une adresse..." autocomplete="off" oninput="onAddrInput(this.value)" onkeydown="onAddrKey(event)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    <div id="autocomplete" class="autocomplete-list hidden"></div>
                </div>
                <div id="coords-box" class="hidden text-xs text-green-400 bg-green-500/10 rounded-lg p-2">‚úì Localis√©e: <span id="coords-text"></span></div>
                <button type="submit" id="btn-add" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold py-3 rounded-xl">‚ûï Ajouter</button>
            </form>
        </div>
    </div>

<script>
// Config
const DEF={password:"CAUCA2025!",orgName:"CAUCA",sessionDuration:8,refreshInterval:15,seuilDistanceKm:2.0};
const CFG=(typeof CONFIG!=='undefined')?{...DEF,...CONFIG}:DEF;
const INIT_ADDR=(typeof ADRESSES_PREDEFINIES!=='undefined')?ADRESSES_PREDEFINIES:[];
const STORE_KEY="hqm-v9",SESS_KEY="hqm-s9";
const HQ_API="https://pannes.hydroquebec.com/pannes/donnees/v3_0";
const NOM_API="https://nominatim.openstreetmap.org";

let S={locs:[],pannes:[],selId:null,filter:'tous',search:'',loading:false,lastUp:null,err:null,showZones:true,selSugg:null};
let map,markers={},panneLayer,autoTimeout,autoIdx=-1,suggs=[];

// Auth
function checkSess(){try{const s=localStorage.getItem(SESS_KEY);if(s){const d=JSON.parse(s);if(new Date(d.exp)>new Date())return true;}}catch(e){}return false;}
function makeSess(){const e=new Date();e.setHours(e.getHours()+CFG.sessionDuration);localStorage.setItem(SESS_KEY,JSON.stringify({exp:e.toISOString()}));}
function handleLogin(e){e.preventDefault();if(document.getElementById('password-input').value===CFG.password){makeSess();document.getElementById('login-screen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');initApp();}else{document.getElementById('error-message').classList.remove('hidden');document.getElementById('login-form').classList.add('shake');setTimeout(()=>document.getElementById('login-form').classList.remove('shake'),300);document.getElementById('password-input').value='';}}
function logout(){localStorage.removeItem(SESS_KEY);location.reload();}

// Storage
function load(){try{const s=localStorage.getItem(STORE_KEY);if(s)S.locs=JSON.parse(s).locs||[];if(!S.locs.length&&INIT_ADDR.length){S.locs=INIT_ADDR.map((a,i)=>({id:Date.now()+i,nom:a.nom,adresse:a.adresse,lat:a.lat,lng:a.lng,enPanne:false,panne:null}));save();}}catch(e){}}
function save(){localStorage.setItem(STORE_KEY,JSON.stringify({locs:S.locs}));}
function resetConfig(){if(confirm("Charger config.js?")){S.locs=INIT_ADDR.map((a,i)=>({id:Date.now()+i,nom:a.nom,adresse:a.adresse,lat:a.lat,lng:a.lng,enPanne:false,panne:null}));save();updateStatus();}}

// API - CORS Proxies
const PROXIES=[
    url=>`https://corsproxy.io/?${encodeURIComponent(url)}`,
    url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
];
async function fetchP(url){
    for(const makeProxy of PROXIES){
        try{
            const proxyUrl=makeProxy(url);
            const r=await fetch(proxyUrl);
            if(r.ok){
                const text=await r.text();
                if(text && text.length>0 && !text.includes('error'))return text;
            }
        }catch(e){}
    }
    throw new Error("Tous les proxies ont √©chou√©");
}
async function fetchHQ(){S.loading=true;S.err=null;updateUI();try{
    const versionUrl=`${HQ_API}/bisversion.json`;
    const vText=await fetchP(versionUrl);
    const v=vText.replace(/["\s]/g,'');
    
    const markersUrl=`${HQ_API}/bismarkers${v}.json`;
    const rawText=await fetchP(markersUrl);
    
    let raw=JSON.parse(rawText);
    
    // Chercher le tableau de pannes dans la structure
    let pannesArray=[];
    if(Array.isArray(raw)){
        pannesArray=raw;
    }else if(raw && typeof raw==='object'){
        for(const key of Object.keys(raw)){
            if(Array.isArray(raw[key])){
                pannesArray=raw[key];
                break;
            }
        }
    }
    
    // Format HQ: [nbClients, dateDebut, dateFin, type, "[lng,lat]", statut, code, id, cause, ""]
    S.pannes=[];
    for(let i=0;i<pannesArray.length;i++){
        const p=pannesArray[i];
        if(!Array.isArray(p)||p.length<5)continue;
        try{
            const coordStr=String(p[4]);
            const coords=JSON.parse(coordStr);
            const lng=parseFloat(coords[0]);
            const lat=parseFloat(coords[1]);
            if(lat&&lng&&lat>40&&lat<65&&lng<-50&&lng>-85){
                S.pannes.push({
                    clients:parseInt(p[0])||0,
                    debut:p[1]||'',
                    fin:p[2]||'',
                    type:p[3]||'',
                    lat:lat,
                    lng:lng,
                    cause:p[8]||'Non sp√©cifi√©e'
                });
            }
        }catch(e){}
    }
    }
    S.lastUp=new Date();
    updateStatus();
    updateZones();
}catch(e){S.err="Donn√©es HQ indisponibles";}S.loading=false;updateUI();}
function dist(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function updateStatus(){S.locs=S.locs.map(loc=>{let enPanne=false,info=null,dMin=Infinity;for(const p of S.pannes){if(!p.lat||!p.lng)continue;const d=dist(loc.lat,loc.lng,p.lat,p.lng);if(d<dMin){dMin=d;if(d<=CFG.seuilDistanceKm){enPanne=true;info={cause:p.cause||'Non sp√©cifi√©e',clients:p.clients||0};}}}return{...loc,enPanne,panne:info,distP:dMin===Infinity?null:dMin.toFixed(1)};});save();updateUI();updateMarkers();}

// Zones HQ
function updateZones(){if(panneLayer)map.removeLayer(panneLayer);if(!S.showZones||!S.pannes.length)return;panneLayer=L.layerGroup();S.pannes.forEach(p=>{if(!p.lat||!p.lng)return;const cl=p.clients||100,r=Math.min(Math.max(cl*3,800),8000);const c=L.circle([p.lat,p.lng],{radius:r,color:'#f97316',fillColor:'#f97316',fillOpacity:0.2,weight:2,opacity:0.7});c.bindPopup(`<b style="color:#f97316">üî• Panne HQ</b><br><small><b>Cause:</b> ${p.cause||'N/A'}<br><b>Clients:</b> ${cl}<br><b>D√©but:</b> ${p.debut||'N/A'}</small>`);panneLayer.addLayer(c);const icon=L.divIcon({className:'',html:'<div class="marker-hq"></div>',iconSize:[14,14],iconAnchor:[7,7]});L.marker([p.lat,p.lng],{icon}).bindPopup(c.getPopup()).addTo(panneLayer);});panneLayer.addTo(map);}
function toggleZones(){S.showZones=!S.showZones;const b=document.getElementById('zones-btn');b.className=`p-2 sm:px-3 sm:py-2 rounded-xl text-sm ${S.showZones?'bg-orange-500/20 border border-orange-500/30 text-orange-400':'bg-white/5 border border-white/10 text-slate-400'}`;S.showZones?updateZones():panneLayer&&map.removeLayer(panneLayer);}

// Autocomplete
async function searchAddr(q){if(q.length<3){hideAuto();return;}showAutoLoad();try{const r=await fetch(`${NOM_API}/search?q=${encodeURIComponent(q)}&format=json&addressdetails=1&limit=5&countrycodes=ca`);const data=await r.json();suggs=data.map(r=>({disp:r.display_name,short:fmtAddr(r),lat:parseFloat(r.lat),lng:parseFloat(r.lon)}));showAuto();}catch(e){hideAuto();}}
function fmtAddr(r){const a=r.address||{},p=[];if(a.house_number)p.push(a.house_number);if(a.road)p.push(a.road);if(a.city||a.town||a.village)p.push(a.city||a.town||a.village);return p.join(', ')||r.display_name.split(',').slice(0,3).join(',');}
function showAuto(){const c=document.getElementById('autocomplete');if(!suggs.length){c.innerHTML='<div style="padding:12px;color:#94a3b8;text-align:center">Aucun r√©sultat</div>';c.classList.remove('hidden');return;}c.innerHTML=suggs.map((s,i)=>`<div class="autocomplete-item ${i===autoIdx?'active':''}" onclick="selSugg(${i})" onmouseenter="autoIdx=${i};hlSugg()"><span>${s.short}</span><small>${s.disp.substring(0,50)}...</small></div>`).join('');c.classList.remove('hidden');}
function showAutoLoad(){document.getElementById('autocomplete').innerHTML='<div style="padding:12px;color:#94a3b8;text-align:center">üîç Recherche...</div>';document.getElementById('autocomplete').classList.remove('hidden');}
function hideAuto(){document.getElementById('autocomplete').classList.add('hidden');autoIdx=-1;}
function hlSugg(){document.querySelectorAll('.autocomplete-item').forEach((el,i)=>el.classList.toggle('active',i===autoIdx));}
function selSugg(i){const s=suggs[i];if(!s)return;document.getElementById('input-addr').value=s.short;S.selSugg=s;document.getElementById('coords-box').classList.remove('hidden');document.getElementById('coords-text').textContent=`${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}`;hideAuto();}
function onAddrInput(v){S.selSugg=null;document.getElementById('coords-box').classList.add('hidden');clearTimeout(autoTimeout);autoTimeout=setTimeout(()=>searchAddr(v),350);}
function onAddrKey(e){if(document.getElementById('autocomplete').classList.contains('hidden'))return;if(e.key==='ArrowDown'){e.preventDefault();autoIdx=Math.min(autoIdx+1,suggs.length-1);hlSugg();}else if(e.key==='ArrowUp'){e.preventDefault();autoIdx=Math.max(autoIdx-1,0);hlSugg();}else if(e.key==='Enter'&&autoIdx>=0){e.preventDefault();selSugg(autoIdx);}else if(e.key==='Escape')hideAuto();}
async function geocode(addr){if(S.selSugg)return{lat:S.selSugg.lat,lng:S.selSugg.lng};const r=await fetch(`${NOM_API}/search?q=${encodeURIComponent(addr+', Qu√©bec, Canada')}&format=json&limit=1`);const d=await r.json();if(d?.length>0)return{lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};throw new Error("Adresse non trouv√©e");}

// Map
function initMap(){map=L.map('map',{center:[46.8,-71.2],zoom:7});L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OSM ¬© CARTO',subdomains:'abcd',maxZoom:19}).addTo(map);setTimeout(()=>map.invalidateSize(),100);}
function updateMarkers(){Object.values(markers).forEach(m=>map.removeLayer(m));markers={};const f=getFiltered(),bounds=[];f.forEach(loc=>{const icon=L.divIcon({className:'',html:`<div class="marker-pin ${loc.enPanne?'panne':'ok'}"></div>`,iconSize:[24,24],iconAnchor:[12,12]});const m=L.marker([loc.lat,loc.lng],{icon}).addTo(map).bindPopup(`<b>${loc.nom}</b><br><small style="color:#94a3b8">${loc.adresse}</small><br><span style="display:inline-block;margin-top:8px;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;${loc.enPanne?'background:#ef4444':'background:#22c55e'};color:white">${loc.enPanne?'‚ö° PANNE':'‚úì OK'}</span>${loc.enPanne&&loc.panne?`<div style="margin-top:8px;padding:8px;background:rgba(239,68,68,0.15);border-radius:6px;font-size:11px;color:#f87171">‚ö†Ô∏è ${loc.panne.cause}<br><span style="color:#94a3b8">${loc.panne.clients} clients</span></div>`:''}`);m.on('click',()=>selLoc(loc.id));markers[loc.id]=m;bounds.push([loc.lat,loc.lng]);});if(bounds.length)bounds.length===1?map.setView(bounds[0],12):map.fitBounds(bounds,{padding:[50,50]});}

// UI
function getFiltered(){return S.locs.filter(l=>(l.nom.toLowerCase().includes(S.search.toLowerCase())||l.adresse.toLowerCase().includes(S.search.toLowerCase()))&&(S.filter==='tous'||(S.filter==='panne'&&l.enPanne)||(S.filter==='normal'&&!l.enPanne)));}
function updateUI(){document.getElementById('stat-total').textContent=S.locs.length;document.getElementById('stat-ok').textContent=S.locs.filter(l=>!l.enPanne).length;document.getElementById('stat-panne').textContent=S.locs.filter(l=>l.enPanne).length;document.getElementById('stat-hq').textContent=S.pannes.length;document.getElementById('last-update').textContent=S.lastUp?S.lastUp.toLocaleTimeString('fr-CA'):'--:--';document.getElementById('status-dot').className=`w-2 h-2 rounded-full ${S.loading?'bg-amber-400 animate-ping':(S.lastUp&&!S.err?'bg-green-400 animate-pulse':'bg-amber-400 animate-pulse')}`;document.getElementById('refresh-text').textContent=S.loading?'...':'Actualiser';const eb=document.getElementById('error-banner');if(S.err){eb.classList.remove('hidden');eb.textContent=S.err;}else eb.classList.add('hidden');renderList();}
function renderList(){const list=document.getElementById('list'),f=getFiltered();if(!f.length){list.innerHTML=`<div class="text-center py-8 text-slate-500"><div class="text-4xl mb-3">üìç</div><p>${S.locs.length?'Aucun r√©sultat':'Ajoutez une adresse'}</p></div>`;return;}list.innerHTML=f.map(l=>`<div onclick="selLoc(${l.id})" class="relative p-3 rounded-xl cursor-pointer group ${S.selId===l.id?'bg-gradient-to-r from-blue-600/30 to-purple-600/30 border-2 border-blue-400':'bg-white/5 border border-white/10 hover:bg-white/10'} ${l.enPanne?'ring-2 ring-red-500/50':''}"><div class="absolute -top-2 -right-2 px-2 py-0.5 rounded-full text-xs font-bold ${l.enPanne?'bg-red-500 text-white animate-pulse-slow':'bg-green-500/80 text-white'}">${l.enPanne?'‚ö° PANNE':'‚úì OK'}</div><div class="flex items-start gap-3"><div class="text-lg">${l.enPanne?'üî¥':'üü¢'}</div><div class="flex-1 min-w-0"><h3 class="font-semibold text-white truncate text-sm">${l.nom}</h3><p class="text-xs text-slate-400 truncate">${l.adresse}</p>${l.enPanne&&l.panne?`<div class="mt-2 p-2 bg-red-500/10 rounded-lg text-xs text-red-400">‚ö†Ô∏è ${l.panne.cause}</div>`:(l.distP?`<div class="mt-1 text-xs text-slate-500">Panne: ${l.distP} km</div>`:'')}</div></div><button onclick="event.stopPropagation();delLoc(${l.id})" class="absolute bottom-2 right-2 p-1.5 hover:bg-red-500/20 rounded-lg opacity-0 group-hover:opacity-100 text-red-400">üóëÔ∏è</button></div>`).join('');}

// Actions
function selLoc(id){S.selId=S.selId===id?null:id;updateUI();if(S.selId&&markers[id]){const l=S.locs.find(x=>x.id===id);map.setView([l.lat,l.lng],14);markers[id].openPopup();}}
function setFilter(f){S.filter=f;document.querySelectorAll('#filter-btns button').forEach(b=>{b.className=`flex-1 py-2 rounded-lg text-xs font-medium ${b.dataset.f===f?'bg-blue-500/20 text-blue-400 border border-blue-500/30':'bg-white/5 text-slate-400'}`});updateUI();updateMarkers();}
function handleSearch(v){S.search=v;updateUI();updateMarkers();}
function openModal(){document.getElementById('modal').classList.remove('hidden');document.getElementById('modal').classList.add('flex');document.getElementById('input-nom').focus();S.selSugg=null;document.getElementById('coords-box').classList.add('hidden');}
function closeModal(){document.getElementById('modal').classList.add('hidden');document.getElementById('modal').classList.remove('flex');document.getElementById('input-nom').value='';document.getElementById('input-addr').value='';hideAuto();S.selSugg=null;document.getElementById('coords-box').classList.add('hidden');}
function delLoc(id){if(confirm('Supprimer?')){S.locs=S.locs.filter(l=>l.id!==id);if(S.selId===id)S.selId=null;save();updateUI();updateMarkers();}}
async function handleAdd(e){e.preventDefault();const nom=document.getElementById('input-nom').value.trim(),addr=document.getElementById('input-addr').value.trim(),btn=document.getElementById('btn-add');btn.disabled=true;btn.textContent='‚è≥ Localisation...';try{const g=await geocode(addr);S.locs.push({id:Date.now(),nom,adresse:addr,lat:g.lat,lng:g.lng,enPanne:false,panne:null});updateStatus();closeModal();}catch(err){alert("Erreur: "+err.message);}finally{btn.disabled=false;btn.textContent='‚ûï Ajouter';}}
async function refreshData(){if(!S.loading)await fetchHQ();}
function exportData(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({date:new Date().toISOString(),locations:S.locs.map(l=>({nom:l.nom,adresse:l.adresse,lat:l.lat,lng:l.lng}))},null,2)],{type:'application/json'}));a.download=`hydro-monitor-${new Date().toISOString().split('T')[0]}.json`;a.click();}
function importData(file){const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.locations){S.locs=[...S.locs,...d.locations.map((l,i)=>({id:Date.now()+i,...l,enPanne:false,panne:null}))];updateStatus();alert(`${d.locations.length} adresse(s) import√©e(s)!`);}}catch(err){alert("Erreur: "+err.message);}};r.readAsText(file);}

// Init
async function initApp(){['org-name','menu-org'].forEach(id=>document.getElementById(id).textContent=CFG.orgName);document.getElementById('login-org').textContent=`Acc√®s r√©serv√© - ${CFG.orgName}`;load();initMap();updateUI();updateMarkers();await refreshData();setInterval(refreshData,CFG.refreshInterval*60*1000);}
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal();});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
document.addEventListener('click',e=>{if(!e.target.closest('#autocomplete')&&!e.target.closest('#input-addr'))hideAuto();});
if(checkSess()){document.getElementById('login-screen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');initApp();}else{document.getElementById('login-org').textContent=`Acc√®s r√©serv√© - ${CFG.orgName}`;}
</script>
</body>
</html>
